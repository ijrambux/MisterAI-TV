<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MisterAI PRO TV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: sans-serif; overflow-x: hidden; }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #1e293b; }
        .channel-card { background: #0f172a; border: 1px solid #1e293b; transition: 0.3s; cursor: pointer; border-radius: 1rem; overflow: hidden; }
        .channel-card:hover { border-color: #3b82f6; transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.2); }
        #video-container { display: none; position: fixed; inset: 0; background: black; z-index: 100; flex-direction: column; }
        video { width: 100%; height: 100%; object-fit: contain; }
    </style>
</head>
<body>

    <div id="video-container">
        <div class="p-4 glass flex justify-between items-center text-white">
            <h2 id="current-channel-name" class="font-bold text-blue-400 font-lg">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„...</h2>
            <button onclick="stopVideo()" class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-full font-bold transition">Ø¥ØºÙ„Ø§Ù‚ Ã—</button>
        </div>
        <video id="video-player" controls autoplay></video>
    </div>

    <nav class="sticky top-0 z-50 glass p-4">
        <div class="max-w-7xl mx-auto flex flex-wrap gap-4 justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">ğŸ“º</div>
                <h1 class="text-xl font-black tracking-tighter">MisterAI <span class="text-blue-500">PRO</span></h1>
            </div>
            <input type="text" id="search-input" onkeyup="filterChannels()" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ù†Ø§ØªÙƒ..." 
                   class="bg-slate-900 border border-slate-700 rounded-xl px-4 py-2 text-sm w-full md:w-80 outline-none focus:ring-2 focus:ring-blue-500 transition-all">
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-6">
        <div id="loading-status" class="text-center py-20">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mb-4"></div>
            <p class="text-slate-400">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±...</p>
        </div>
        
        <div id="channels-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-8 gap-4">
            </div>
    </main>

    <script>
        let allChannels = [];
        const videoContainer = document.getElementById('video-container');
        const videoPlayer = document.getElementById('video-player');
        const channelNameDisplay = document.getElementById('current-channel-name');

        // ÙˆØ¸ÙŠÙØ© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù app.py Ø§Ù„Ù…Ø±ÙÙˆØ¹ Ø¹Ù„Ù‰ Render
        async function loadChannels() {
            try {
                const response = await fetch('/api/channels'); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø°ÙŠ Ø£Ø±Ø³Ù„ØªÙ‡ Ù…Ù† GitHub
                const m3uData = await response.text();
                parseM3U(m3uData);
                document.getElementById('loading-status').style.display = 'none';
            } catch (error) {
                document.getElementById('loading-status').innerHTML = "ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª âŒ";
            }
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†Øµ M3U ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø±Ù…Ø¬ÙŠØ©
        function parseM3U(data) {
            const lines = data.split('\n');
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].startsWith('#EXTINF')) {
                    const name = lines[i].split(',')[1] || "Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©";
                    const logo = lines[i].match(/tvg-logo="([^"]+)"/)?.[1] || "";
                    const url = lines[i + 1]?.trim();
                    if (url && url.startsWith('http')) {
                        allChannels.push({ name, logo, url });
                    }
                }
            }
            displayChannels(allChannels);
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ù†ÙˆØ§Øª ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©
        function displayChannels(channels) {
            const grid = document.getElementById('channels-grid');
            grid.innerHTML = channels.map(ch => `
                <div onclick="startPlayer('${ch.url}', '${ch.name}')" class="channel-card p-4 text-center shadow-xl">
                    <img src="${ch.logo}" class="h-16 w-full object-contain mb-3" onerror="this.src='https://via.placeholder.com/150/1e293b/3b82f6?text=TV'">
                    <p class="text-[10px] font-bold truncate text-slate-300 px-1">${ch.name}</p>
                </div>
            `).join('');
        }

        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶ØºØ· ÙˆØ§Ù„ØªØ´ØºÙŠÙ„
        function startPlayer(url, name) {
            console.log("ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø·:", url);
            channelNameDisplay.innerText = name;
            videoContainer.style.display = 'flex';

            if (Hls.isSupported() && (url.includes('m3u8') || url.includes('.ts'))) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(videoPlayer);
                hls.on(Hls.Events.MANIFEST_PARSED, () => videoPlayer.play());
            } else {
                videoPlayer.src = url;
                videoPlayer.play();
            }
        }

        function stopVideo() {
            videoContainer.style.display = 'none';
            videoPlayer.pause();
            videoPlayer.src = "";
        }

        function filterChannels() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const filtered = allChannels.filter(c => c.name.toLowerCase().includes(query));
            displayChannels(filtered);
        }

        window.onload = loadChannels;
    </script>
</body>
</html>
