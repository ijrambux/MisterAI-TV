<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MisterAI PRO TV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { background-color: #020617; color: #e2e8f0; font-family: sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #1e293b; }
        .card { background: #0f172a; border: 1px solid #1e293b; transition: 0.3s; }
        .card:hover { border-color: #3b82f6; transform: translateY(-5px); }
    </style>
</head>
<body>

    <div id="player-box" class="fixed inset-0 z-[100] bg-black hidden flex flex-col">
        <div class="p-4 glass flex justify-between items-center">
            <h2 id="title" class="font-bold text-blue-400">تشغيل...</h2>
            <button onclick="closePlayer()" class="bg-red-600 px-6 py-1 rounded-full text-white">إغلاق ×</button>
        </div>
        <video id="video" class="w-full h-full" controls autoplay></video>
    </div>

    <nav class="sticky top-0 z-50 glass p-4 flex flex-wrap gap-4 justify-between items-center">
        <h1 class="text-xl font-black text-white">MisterAI <span class="text-blue-500">PRO</span></h1>
        <input type="text" id="search" onkeyup="filter()" placeholder="بحث عن قناة..." class="bg-slate-900 border border-slate-700 rounded-xl px-4 py-2 text-sm w-full md:w-80 outline-none focus:ring-2 focus:ring-blue-500">
    </nav>

    <div id="grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 lg:grid-cols-7 gap-4 p-6">
        <p class="col-span-full text-center py-20">جاري جلب القنوات...</p>
    </div>

    <script>
        let allChannels = [];

        async function start() {
            const res = await fetch('/api/channels');
            const data = await res.text();
            const lines = data.split('\n');
            
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].startsWith('#EXTINF')) {
                    const name = lines[i].split(',')[1] || "قناة";
                    const logo = lines[i].match(/tvg-logo="([^"]+)"/)?.[1] || "";
                    const url = lines[i+1]?.trim();
                    if(url) allChannels.push({name, logo, url});
                }
            }
            show(allChannels);
        }

        function show(list) {
            const grid = document.getElementById('grid');
            grid.innerHTML = list.map(ch => `
                <div onclick="play('${ch.url}', '${ch.name}')" class="card p-4 rounded-2xl text-center cursor-pointer">
                    <img src="${ch.logo}" class="h-12 mx-auto mb-2 object-contain" onerror="this.src='https://via.placeholder.com/50?text=TV'">
                    <p class="text-[10px] font-bold truncate">${ch.name}</p>
                </div>
            `).join('');
        }

        function filter() {
            const q = document.getElementById('search').value.toLowerCase();
            show(allChannels.filter(c => c.name.toLowerCase().includes(q)));
        }

        function play(url, name) {
            const box = document.getElementById('player-box');
            const v = document.getElementById('video');
            document.getElementById('title').innerText = name;
            box.classList.remove('hidden');

            if (Hls.isSupported() && url.includes('m3u8')) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(v);
            } else { v.src = url; }
        }

        function closePlayer() {
            const v = document.getElementById('video');
            document.getElementById('player-box').classList.add('hidden');
            v.pause(); v.src = "";
        }

        window.onload = start;
    </script>
</body>
</html>
