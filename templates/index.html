<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MisterAI PRO TV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { background-color: #050a18; color: #f1f5f9; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .nav-glass { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #1e293b; }
        .ch-card { background: #0f172a; border: 1px solid #1e293b; transition: 0.3s; cursor: pointer; border-radius: 15px; }
        .ch-card:hover { border-color: #3b82f6; transform: translateY(-5px); box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
        #player-overlay { display: none; position: fixed; inset: 0; background: #000; z-index: 1000; flex-direction: column; }
        video { width: 100%; height: 80vh; background: #000; }
    </style>
</head>
<body>

    <div id="player-overlay">
        <div class="p-4 flex justify-between items-center bg-slate-900 border-b border-slate-800">
            <h2 id="ch-name" class="font-bold text-blue-400">تشغيل الآن...</h2>
            <button onclick="closeStream()" class="bg-red-600 px-6 py-1 rounded-full text-white font-bold">إغلاق ×</button>
        </div>
        <video id="main-video" controls autoplay playsinline></video>
        <div class="p-4 text-center text-xs text-slate-500 italic">ملاحظة: إذا لم يعمل البث، تأكد من سماح المتصفح بالمحتوى غير الآمن.</div>
    </div>

    <nav class="sticky top-0 z-50 nav-glass p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-black italic">MISTERAI <span class="text-blue-500">PRO</span></h1>
            <input type="text" id="search" onkeyup="doSearch()" placeholder="بحث سريع..." class="bg-slate-900 border border-slate-700 rounded-full px-6 py-2 text-sm w-48 md:w-80 outline-none focus:ring-2 focus:ring-blue-500">
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-6">
        <div id="loading" class="text-center py-20 text-slate-500">جاري الاتصال بسيرفر فرانكفورت...</div>
        <div id="channels-box" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 lg:grid-cols-7 gap-6"></div>
    </main>

    <script>
        let channelList = [];

        async function init() {
            try {
                const res = await fetch('/api/channels');
                const rawData = await res.text();
                parseData(rawData);
                document.getElementById('loading').style.display = 'none';
            } catch (e) {
                document.getElementById('loading').innerText = "خطأ في الاتصال";
            }
        }

        function parseData(text) {
            const lines = text.split('\n');
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].includes('#EXTINF')) {
                    const name = lines[i].split(',')[1] || "Unknown";
                    const logo = lines[i].match(/tvg-logo="([^"]+)"/)?.[1] || "";
                    const url = lines[i+1]?.trim();
                    if(url) channelList.push({name, logo, url});
                }
            }
            render(channelList);
        }

        function render(data) {
            const box = document.getElementById('channels-box');
            box.innerHTML = data.map(c => `
                <div onclick="openStream('${c.url}', '${c.name}')" class="ch-card p-4 text-center">
                    <img src="${c.logo}" class="h-12 w-full object-contain mb-3" onerror="this.src='https://via.placeholder.com/100/1e293b/3b82f6?text=TV'">
                    <p class="text-[10px] font-bold truncate">${c.name}</p>
                </div>
            `).join('');
        }

        function openStream(url, name) {
            const overlay = document.getElementById('player-overlay');
            const video = document.getElementById('main-video');
            document.getElementById('ch-name').innerText = name;
            overlay.style.display = 'flex';

            if (Hls.isSupported() && url.includes('m3u8')) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            } else {
                video.src = url;
                video.play().catch(err => {
                    alert("المتصفح حظر التشغيل. يرجى تفعيل 'Insecure Content' من إعدادات الموقع.");
                });
            }
        }

        function closeStream() {
            const video = document.getElementById('main-video');
            document.getElementById('player-overlay').style.display = 'none';
            video.pause(); video.src = "";
        }

        function doSearch() {
            const q = document.getElementById('search').value.toLowerCase();
            render(channelList.filter(x => x.name.toLowerCase().includes(q)));
        }

        window.onload = init;
    </script>
</body>
</html>
