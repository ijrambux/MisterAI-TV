<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>MisterAI IPTV PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { background: #020617; color: white; font-family: sans-serif; }
        .channel-card { background: #0f172a; border: 1px solid #1e293b; transition: 0.3s; cursor: pointer; }
        .channel-card:hover { border-color: #3b82f6; transform: translateY(-3px); }
    </style>
</head>
<body class="h-screen flex flex-col">
    <nav class="p-4 border-b border-slate-800 bg-slate-950 flex justify-between items-center">
        <h1 class="text-xl font-black text-blue-500">MisterAI <span class="text-white">TV</span></h1>
        <div id="loader" class="text-xs text-blue-400">جاري فحص السيرفرات...</div>
    </nav>

    <div class="flex flex-1 overflow-hidden">
        <main class="flex-1 overflow-y-auto p-4 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4" id="grid"></main>
        
        <aside id="player" class="w-96 bg-black border-r border-slate-800 hidden flex flex-col">
            <video id="video" class="w-full aspect-video" controls autoplay></video>
            <div class="p-4"><h2 id="ch-name" class="font-bold"></h2></div>
        </aside>
    </div>

    <script>
        const grid = document.getElementById('grid');
        const hls = new Hls();
        
        async function start() {
            const res = await fetch('/api/servers');
            const data = await res.json();
            data.servers.forEach(url => loadFromM3U(url));
        }

        async function loadFromM3U(url) {
            try {
                const r = await fetch(url);
                const txt = await r.text();
                const matches = [...txt.matchAll(/#EXTINF:-1.*?tvg-logo="(.*?)".*?,(.*?)\n(http.*)/g)];
                matches.slice(0, 50).forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'channel-card p-3 rounded-xl text-center';
                    div.innerHTML = `<img src="${m[1]}" class="h-12 mx-auto mb-2" onerror="this.src='https://via.placeholder.com/50'"><p class="text-[10px] truncate">${m[2]}</p>`;
                    div.onclick = () => {
                        document.getElementById('player').classList.remove('hidden');
                        document.getElementById('ch-name').innerText = m[2];
                        if (Hls.isSupported()) { hls.loadSource(m[3]); hls.attachMedia(document.getElementById('video')); }
                    };
                    grid.appendChild(div);
                });
                document.getElementById('loader').innerText = "تم التحديث ✅";
            } catch (e) { console.error("سيرفر بطيء"); }
        }
        start();
    </script>
</body>
</html>
