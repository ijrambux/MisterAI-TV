<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MisterAI IPTV PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #020617; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .channel-card { background: #0f172a; border: 1px solid #1e293b; transition: 0.3s; cursor: pointer; position: relative; overflow: hidden; }
        .channel-card:hover { border-color: #3b82f6; transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .channel-card img { height: 60px; object-fit: contain; margin-bottom: 8px; }
        .loader-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #video-container { background: radial-gradient(circle, #111 0%, #000 100%); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <nav class="p-4 bg-slate-950 border-b border-slate-800 flex justify-between items-center shadow-xl z-50">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg"><i class="fas fa-play text-white"></i></div>
            <h1 class="text-xl font-black tracking-tighter">MisterAI <span class="text-blue-500">TV</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <div id="status-icon" class="text-yellow-500 text-xs flex items-center gap-2">
                <i class="fas fa-circle-notch loader-spin"></i>
                <span id="status-text">جاري مزامنة السيرفرات...</span>
            </div>
            <input type="text" id="search" placeholder="ابحث عن قناة..." class="bg-slate-900 border border-slate-700 px-4 py-1.5 rounded-full text-sm outline-none focus:border-blue-500 w-64 transition-all">
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden">
        <main class="flex-1 overflow-y-auto p-6" id="main-content">
            <div id="grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4">
                </div>
        </main>

        <aside id="player-panel" class="w-[450px] bg-black border-r border-slate-800 hidden flex flex-col animate-fade-in">
            <div id="video-container" class="aspect-video w-full relative">
                <video id="video" class="w-full h-full" controls autoplay></video>
            </div>
            <div class="p-6">
                <h2 id="now-playing" class="text-2xl font-bold mb-1">اسم القناة</h2>
                <div class="flex items-center gap-2 text-green-500 text-sm mb-6">
                    <span class="relative flex h-2 w-2">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                    بث مباشر عالي الجودة
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="toggleFS()" class="bg-blue-600 hover:bg-blue-700 p-3 rounded-xl font-bold transition-all"><i class="fas fa-expand mr-2"></i> ملء الشاشة</button>
                    <button class="bg-slate-800 hover:bg-slate-700 p-3 rounded-xl font-bold transition-all"><i class="fas fa-heart mr-2"></i> المفضلة</button>
                </div>
            </div>
        </aside>
    </div>

    <script>
        const grid = document.getElementById('grid');
        const video = document.getElementById('video');
        const hls = new Hls();
        let allChannels = [];

        async function init() {
            try {
                const res = await fetch('/api/servers');
                const data = await res.json();
                
                // جلب القنوات من كل سيرفر عبر البروكسي الداخلي
                for (const url of data.servers) {
                    fetchAndParse(url);
                }
            } catch (e) {
                updateStatus("خطأ في الاتصال بالسيرفر الرئيسي", "text-red-500");
            }
        }

        async function fetchAndParse(url) {
            try {
                // نستخدم البروكسي لتجنب مشاكل الـ HTTPS
                const res = await fetch(`/api/proxy?url=${encodeURIComponent(url)}`);
                const text = await res.text();
                
                const regex = /#EXTINF:-1.*?tvg-logo="(.*?)".*?,(.*?)\n(http.*)/g;
                let match;
                let count = 0;

                while ((match = regex.exec(text)) !== null && count < 100) {
                    const channel = { name: match[2].trim(), logo: match[1], url: match[3].trim() };
                    allChannels.push(channel);
                    renderCard(channel);
                    count++;
                }
                updateStatus(`متصل: تم تحميل ${allChannels.length} قناة`, "text-green-500");
            } catch (e) {
                console.log("سيرفر لم يستجب");
            }
        }

        function renderCard(ch) {
            const card = document.createElement('div');
            card.className = 'channel-card p-4 rounded-2xl text-center';
            card.innerHTML = `
                <img src="${ch.logo}" class="mx-auto" onerror="this.src='https://via.placeholder.com/150?text=TV'">
                <p class="text-[11px] font-medium truncate w-full">${ch.name}</p>
            `;
            card.onclick = () => play(ch.url, ch.name);
            grid.appendChild(card);
        }

        function play(url, name) {
            document.getElementById('player-panel').classList.remove('hidden');
            document.getElementById('now-playing').innerText = name;
            
            if (Hls.isSupported()) {
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
                video.play();
            }
        }

        function updateStatus(msg, colorClass) {
            const statusText = document.getElementById('status-text');
            const icon = document.getElementById('status-icon');
            statusText.innerText = msg;
            icon.className = `${colorClass} text-xs flex items-center gap-2`;
        }

        // البحث
        document.getElementById('search').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            grid.innerHTML = '';
            const filtered = allChannels.filter(c => c.name.toLowerCase().includes(term));
            filtered.forEach(c => renderCard(c));
        });

        function toggleFS() {
            if (video.requestFullscreen) video.requestFullscreen();
            else if (video.webkitRequestFullscreen) video.webkitRequestFullscreen();
        }

        init();
    </script>
</body>
</html>
