<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>MisterAI TV Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #020617; color: #f1f5f9; }
        .channel-card { transition: 0.3s; background: #0f172a; border: 1px solid #1e293b; }
        .channel-card:hover { transform: translateY(-5px); border-color: #3b82f6; box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.2); }
        .active-ring { ring: 2px solid #3b82f6; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <nav class="h-16 flex items-center justify-between px-8 bg-[#0f172a] border-b border-slate-800 shadow-lg">
        <div class="flex items-center gap-2">
            <i class="fas fa-bolt text-blue-500 text-2xl"></i>
            <span class="text-xl font-black uppercase tracking-tighter">MisterAI <span class="text-blue-500 text-sm">TV</span></span>
        </div>
        <div class="relative w-1/3">
            <input type="text" id="searchBox" placeholder="ابحث عن قناة في جميع السيرفرات..." 
                   class="w-full bg-slate-900 border border-slate-700 py-2 px-10 rounded-full text-sm focus:border-blue-500 outline-none">
            <i class="fas fa-search absolute right-4 top-3 text-slate-500"></i>
        </div>
        <div id="connectionStatus" class="text-xs text-green-500"><i class="fas fa-circle mr-1"></i> السيرفر متصل</div>
    </nav>

    <div class="flex flex-1 overflow-hidden">
        <main class="flex-1 overflow-y-auto p-6">
            <div id="loadingInfo" class="text-center py-20">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                <p class="text-slate-400">جاري فحص السيرفرات ودمج القنوات...</p>
            </div>
            
            <div id="grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-5"></div>
        </main>

        <aside id="playerSide" class="w-[400px] bg-black/50 border-r border-slate-800 p-4 hidden flex flex-col">
            <div class="aspect-video bg-black rounded-xl overflow-hidden shadow-2xl mb-4">
                <video id="mainVideo" class="w-full h-full" controls autoplay></video>
            </div>
            <div class="p-2">
                <h2 id="channelTitle" class="text-xl font-bold text-white mb-2">اسم القناة</h2>
                <div class="flex gap-2">
                    <span class="bg-blue-600/20 text-blue-400 px-3 py-1 rounded-md text-[10px] font-bold uppercase">Live HD</span>
                    <span class="bg-slate-800 text-slate-400 px-3 py-1 rounded-md text-[10px] font-bold uppercase">MisterAI Stream</span>
                </div>
            </div>
        </aside>
    </div>

    <script>
        const grid = document.getElementById('grid');
        const searchBox = document.getElementById('searchBox');
        const video = document.getElementById('mainVideo');
        const hls = new Hls();
        let database = [];

        // جلب القنوات عند التشغيل
        fetch('/api/load_all')
            .then(r => r.json())
            .then(data => {
                database = data;
                document.getElementById('loadingInfo').style.display = 'none';
                render(database);
            });

        function render(list) {
            grid.innerHTML = '';
            list.forEach(ch => {
                const card = document.createElement('div');
                card.className = 'channel-card p-4 rounded-2xl cursor-pointer group';
                card.innerHTML = `
                    <div class="relative mb-3">
                        <img src="${ch.logo}" class="w-full h-24 object-contain rounded-lg bg-black/40 p-2">
                        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 bg-blue-600/40 rounded-lg transition-all">
                            <i class="fas fa-play text-white text-2xl"></i>
                        </div>
                    </div>
                    <h3 class="text-xs font-bold truncate text-center">${ch.name}</h3>
                `;
                card.onclick = () => playChannel(ch.url, ch.name);
                grid.appendChild(card);
            });
        }

        function playChannel(url, name) {
            document.getElementById('playerSide').classList.remove('hidden');
            document.getElementById('channelTitle').innerText = name;
            
            if (Hls.isSupported()) {
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
            }
        }

        // بحث لحظي
        searchBox.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = database.filter(c => c.name.toLowerCase().includes(query));
            render(filtered);
        });
    </script>
</body>
</html>
