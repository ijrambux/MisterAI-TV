<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>MisterAI IPTV PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { background: #020617; color: white; }
        .card { background: #0f172a; border: 1px solid #1e293b; cursor: pointer; transition: 0.3s; }
        .card:hover { border-color: #3b82f6; transform: scale(1.02); }
    </style>
</head>
<body class="h-screen flex flex-col">
    <nav class="p-4 bg-slate-950 border-b border-slate-800 flex justify-between items-center">
        <h1 class="text-xl font-bold text-blue-500">MisterAI TV</h1>
        <div id="status" class="text-xs text-blue-300 animate-pulse">جاري جلب القنوات من 5 سيرفرات...</div>
    </nav>

    <div class="flex flex-1 overflow-hidden">
        <main class="flex-1 overflow-y-auto p-4 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4" id="grid"></main>
        <aside id="player" class="w-96 bg-black hidden border-r border-slate-800">
            <video id="video" class="w-full aspect-video" controls autoplay></video>
            <div class="p-4"><h2 id="ch-name" class="font-bold"></h2></div>
        </aside>
    </div>

    <script>
        const grid = document.getElementById('grid');
        const hls = new Hls();

        async function init() {
            const res = await fetch('/api/servers');
            const data = await res.json();
            for (const url of data.servers) {
                fetchChannels(url);
            }
        }

        async function fetchChannels(url) {
            try {
                // استخدام البروكسي لتجاوز حظر الـ HTTP
                const r = await fetch(`/api/proxy?url=${encodeURIComponent(url)}`);
                const txt = await r.text();
                const regex = /#EXTINF:-1.*?tvg-logo="(.*?)".*?,(.*?)\n(http.*)/g;
                let match;
                while ((match = regex.exec(txt)) !== null) {
                    addCard(match[2], match[1], match[3]);
                }
                document.getElementById('status').innerText = "متصل: القنوات جاهزة ✅";
            } catch (e) { console.error("سيرفر بطيء"); }
        }

        function addCard(name, logo, url) {
            const div = document.createElement('div');
            div.className = 'card p-3 rounded-xl text-center';
            div.innerHTML = `<img src="${logo}" class="h-12 mx-auto mb-2" onerror="this.src='https://via.placeholder.com/100'"><p class="text-[10px] truncate">${name}</p>`;
            div.onclick = () => {
                document.getElementById('player').classList.remove('hidden');
                document.getElementById('ch-name').innerText = name;
                if (Hls.isSupported()) { hls.loadSource(url); hls.attachMedia(document.getElementById('video')); }
            };
            grid.appendChild(div);
        }
        init();
    </script>
</body>
</html>
