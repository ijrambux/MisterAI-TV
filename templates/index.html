<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MisterAI IPTV Turbo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: white; }
        .channel-card { background: #1e293b; transition: 0.3s; }
        .channel-card:hover { transform: scale(1.05); background: #334155; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <nav class="p-4 bg-slate-900 border-b border-slate-800 flex justify-between items-center">
        <h1 class="text-xl font-bold text-blue-500"><i class="fas fa-tv mr-2"></i> MisterAI TV</h1>
        <div id="status" class="text-xs text-slate-400">جاري الاتصال بالسيرفرات...</div>
    </nav>

    <div class="flex flex-1 overflow-hidden">
        <main class="flex-1 overflow-y-auto p-4">
            <div id="channel-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                </div>
        </main>

        <aside id="player-section" class="w-1/3 bg-black border-r border-slate-800 hidden flex flex-col">
            <div class="aspect-video">
                <video id="video" class="w-full h-full" controls autoplay></video>
            </div>
            <div class="p-4">
                <h2 id="current-name" class="text-lg font-bold">اسم القناة</h2>
                <p class="text-sm text-slate-400">بث مباشر بجودة عالية</p>
            </div>
        </aside>
    </div>

    <script>
        const grid = document.getElementById('channel-grid');
        const video = document.getElementById('video');
        const hls = new Hls();

        async function init() {
            try {
                const res = await fetch('/api/servers');
                const data = await res.json();
                document.getElementById('status').innerText = `تم العثور على ${data.servers.length} سيرفرات`;
                
                // تحميل القنوات من كل سيرفر تدريجياً
                data.servers.forEach(url => fetchChannels(url));
            } catch (e) {
                document.getElementById('status').innerText = "خطأ في الاتصال بالسيرفر الرئيسي";
            }
        }

        async function fetchChannels(url) {
            try {
                const res = await fetch(url);
                const text = await res.text();
                const regex = /#EXTINF:-1.*?tvg-logo="(.*?)".*?,(.*?)\n(http.*)/g;
                let match;
                
                while ((match = regex.exec(text)) !== null) {
                    createCard(match[2], match[1], match[3]);
                }
            } catch (e) { console.log("سيرفر لم يستجب"); }
        }

        function createCard(name, logo, url) {
            const div = document.createElement('div');
            div.className = 'channel-card p-3 rounded-xl cursor-pointer text-center';
            div.innerHTML = `
                <img src="${logo || 'https://via.placeholder.com/100'}" class="h-16 mx-auto mb-2 object-contain" onerror="this.src='https://via.placeholder.com/100'">
                <p class="text-[10px] font-bold truncate">${name}</p>
            `;
            div.onclick = () => {
                document.getElementById('player-section').classList.remove('hidden');
                document.getElementById('current-name').innerText = name;
                if (Hls.isSupported()) {
                    hls.loadSource(url);
                    hls.attachMedia(video);
                }
            };
            grid.appendChild(div);
        }

        init();
    </script>
</body>
</html>
